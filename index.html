<!DOCTYPE html>
<html lang="en">
<head>
<title>Diablo III Survivability Calculator</title>
<script type="text/javascript" src="knockout-2.1.0.js"></script>
<link type="text/css" href="bootstrap.min.css" rel="stylesheet" />
<link type="text/css" href="style.css" rel="stylesheet" />
</head>
<body>
<h1>Diablo III Item Calculator</h1>
<h2>Items</h2>
<table class="table table-striped table-condensed table-bordered item-table">
  <thead>
    <tr>
      <th>Slot</th>
      <th>Armor</th>
      <th>Strength</th>
      <th>Dexterity</th>
      <th>Intelligence</th>
      <th>Vitality</th>
      <th>All Res</th>
      <th>Single Res</th>
      <th>Life Regen</th>
      <th>Min Damage</th>
      <th>Max Damage</th>
      <th>Crit Chance</th>
      <th>Crit Amount</th>
      <th>IAS</th>
      <th>DPS</th>
    </tr>
  </thead>
  <tbody>
    <!-- ko foreach: items -->
    <tr>
      <td data-bind="text: slot" />
      <td>
        <!-- ko if: $data instanceof Item -->
          <input class="input-small" data-bind="value: armor, valueUpdate: 'afterkeydown'" />
        <!-- /ko -->

        <!-- ko if: $data instanceof Weapon -->
          <select data-bind="options: weapons, value: wpn, optionsText : 'name'"></select>
        <!-- /ko -->
      </td>
      <td>
        <input class="input-small" data-bind="value: strength, valueUpdate: 'afterkeydown'" />
      </td>
      <td>
        <input class="input-small" data-bind="value: dexterity, valueUpdate: 'afterkeydown'" />
      </td>
      <td>
        <input class="input-small" data-bind="value: intelligence, valueUpdate: 'afterkeydown'" />
      </td>
      <td>
        <input class="input-small" data-bind="value: vitality, valueUpdate: 'afterkeydown'" />
      </td>
      <td>
        <input class="input-small" data-bind="value: allres, valueUpdate: 'afterkeydown'" />
      </td>
      <td>
        <input class="input-small" data-bind="value: singleres, valueUpdate: 'afterkeydown'" />
      </td>
      <td>
        <input class="input-small" data-bind="value: regen, valueUpdate: 'afterkeydown'" />
      </td>
      <td>
        <input class="input-small" data-bind="value: mindmg, valueUpdate: 'afterkeydown'" />
      </td>
      <td>
        <input class="input-small" data-bind="value: maxdmg, valueUpdate: 'afterkeydown'" />
      </td>
      <td>
        <input class="input-small" data-bind="value: critchance, valueUpdate: 'afterkeydown'" />
      </td>
      <td>
        <input class="input-small" data-bind="value: critamt, valueUpdate: 'afterkeydown'" />
      </td>
      <td>
        <input class="input-small" data-bind="value: ias, valueUpdate: 'afterkeydown'" />
      </td>
      <td data-bind="percent: $parent.excludedps($index()), digits: 0" />
    </tr>
    <!-- /ko -->
    <tr>
      <td>Total</td>
      <td data-bind="text: items.sum('armor')" />
      <td data-bind="text: items.sum('strength')" />
      <td data-bind="text: items.sum('dexterity')" />
      <td data-bind="text: items.sum('intelligence')" />
      <td data-bind="text: items.sum('vitality')" />
      <td data-bind="text: items.sum('allres')" />
      <td data-bind="text: items.sum('singleres')" />
      <td data-bind="text: items.sum('regen')" />
      <td data-bind="text: items.sum('mindmg')" />
      <td data-bind="text: items.sum('maxdmg')" />
      <td data-bind="percent: items.sum('critchance')() / 100" />
      <td data-bind="percent: items.sum('critamt')() / 100" />
      <td data-bind="percent: items.sum('ias')() / 100" />
      <td />
    </tr>
  </tbody>
</table>

<h2>Character Sheet</h2>
<table class="table table-striped table-bordered char-table">
  <tbody>
    <tr>
      <th>Class</th>
      <td>
        <select data-bind="options: classes, value: clss, optionsText: 'name'"></select>
      </td>
    </tr>
    <tr>
      <th>Skills</th>
      <td data-bind="foreach: $data.clss().skills">
        <label class="checkbox">
          <input type="checkbox" data-bind="checked: selected">
          <span data-bind="text: name" />
        </label>
      </td>
    </tr>
    <tr>
      <th>Follower</th>
      <td>
        <select data-bind="options: followers, value : follower, optionsText : 'name'"></select>
      </td>
    </tr>
    <tr>
      <th>Follower Skills</th>
      <td data-bind="foreach: $data.follower().skills">
        <label class="checkbox">
          <input type="checkbox" data-bind="checked: selected">
          <span data-bind="text: name" />
        </label>
      </td>
    </tr>
    <tr>
      <th>Level</th>
      <td>
        <input class="input-small" data-bind="value: level, valueUpdate: 'afterkeydown'" />
      </td>
    </tr>
    <tr>
      <th>Strength</th>
      <td data-bind="text: strength" />
    </tr>
    <tr>
      <th>Dexterity</th>
      <td data-bind="text: dexterity" />
    </tr>
    <tr>
      <th>Intelligence</th>
      <td data-bind="text: intelligence" />
    </tr>
    <tr>
      <th>Vitality</th>
      <td data-bind="text: vitality" />
    </tr>
    <tr>
      <th>Life</th>
      <td data-bind="text: life" />
    </tr>
    <tr>
      <th>Critical Chance</th>
      <td data-bind="percent: critchance, digits: 0" />
    </tr>
    <tr>
      <th>Critical Amount</th>
      <td data-bind="percent: critamt, digits: 0" />
    </tr>
    <tr>
      <th>Damage</th>
      <td data-bind="fixed: damage, digits: 0" />
    </tr>
    <tr>
      <th>Attacks/Sec</th>
      <td data-bind="fixed: aps, digits: 2" />
    </tr>
    <tr>
      <th>DPS</th>
      <td data-bind="fixed: dps, digits: 0" />
    </tr>
    <tr>
      <th>Dodge</th>
      <td data-bind="percent: dodge" />
    </tr>
    <tr>
      <th>Armor</th>
      <td data-bind="fixed: armor, digits: 0" />
    </tr>
    <tr>
      <th>Damage Reduction</th>
      <td data-bind="percent: dr" />
    </tr>
    <tr>
      <th>Avg. Resistance</th>
      <td data-bind="fixed: avgres, digits: 0" />
    </tr>
    <tr>
      <th>Resistance DR</th>
      <td data-bind="percent: resreduct" />
    </tr>
  </tbody>
</table>

<h2>Survivability</h2>
<table class="table table-striped table-bordered">
  <tbody>
    <tr>
      <th>Effective HP</th>
      <td data-bind="floor: ehp" />
    </tr>
    <tr>
    digits)<th>Effective HP (w/ Dodge)</th>
      <td data-bind="floor: ehpdodge" />
    </tr>
    <tr>
      <th>Survivable Damage (10 sec)</th>
      <td data-bind="floor: survive10" />
    </tr>
  </tbody>
</table>

<h2>Item Contribution</h2>
<table class="table table-striped table-bordered">
</table>

<h2>Skills</h2>

<script type="text/javascript">

function coalesce() {
  for (var i = 0; i < arguments.length; ++i) {
    if (arguments[i] !== null && arguments[i] !== undefined) {
      return arguments[i];
    }
  }
}

var Formula = {
  stat : function(stat, c, ei) {
    var multiplier = 1;
    if (stat === 'vitality') {
      multiplier = 2;
    } else if (stat === c.clss().primary) {
      multiplier = 3;
    }
    return 7 + c.level() * multiplier + c.getItemStat(stat, ei);
  },
  life : function(c) {
    var level = +c.level(),
        vitality = +c.vitality();
    return 36 + 4 + level + Math.max(10, level - 25) * vitality;
  },
  criticalChance : function(c, ei) {
    var item_chance = c.getItemStat('critchance', ei),
        skill_chance = c.getSkillStat('crit', ei);
    return (5 + item_chance + skill_chance) / 100;
  },
  criticalAmount : function(c, ei) {
    var item_amount = c.getItemStat('critamt', ei);
    return (50 + item_amount) / 100;
  },
  criticalDamage : function(c, ei) {
    return this.criticalChance(c, ei) * this.criticalAmount(c, ei);
  },
  attacksPerSecond : function(c, ei) {
    var weapon_speed = ei == 11 ? 1 : c.items()[11].wpn().speed,
        ias = c.getItemStat('ias', ei);
    return (1 + ias/100) * weapon_speed;
  },
  damage : function(c, ei) {
    var weapon_damage = Math.max(4, c.getItemStat('mindmg', ei) + c.getItemStat('maxdmg', ei)),
        primary_stat = this.stat(c.clss().primary, c, ei),
        skill_damage = c.getSkillStat('damage');
    return (weapon_damage / 2) * (1 + this.criticalDamage(c)) * (1 + primary_stat / 100) * (1 + skill_damage / 100);
  },
  dps : function(c, ei) {
    return this.damage(c, ei) * this.attacksPerSecond(c, ei);
  }
};

ko.observableArray.fn.sum = function(key) {
  return ko.computed(function() {
    return this().map(function(x) { return x[key]() | 0; })
                 .reduce(function(a, b) { return a + b; });
  }, this);
}

ko.bindingHandlers.percent = {
  update : function(el, valueAccessor, allBindingsAccessor) {
    var value = valueAccessor(),
        allBindings = allBindingsAccessor(),
        digits = coalesce(allBindings.digits, 2),
        formatted = (ko.utils.unwrapObservable(value) * 100).toFixed(digits) + '%';
    ko.bindingHandlers.text.update(el, function() { return formatted; });
  }
}

ko.bindingHandlers.floor = {
  update : function(el, valueAccessor) {
    var value = valueAccessor(),
        formatted = Math.floor(ko.utils.unwrapObservable(value));
    ko.bindingHandlers.text.update(el, function() { return formatted; });
  }
}

ko.bindingHandlers.fixed = {
  update : function(el, valueAccessor, allBindingsAccessor) {
    var value = valueAccessor(),
        allBindings = allBindingsAccessor(),
        digits = coalesce(allBindings.digits, 1),
        formatted = ko.utils.unwrapObservable(value).toFixed(digits);
    ko.bindingHandlers.text.update(el, function() { return formatted; });
  }
}

function Item(slot, items, character) {
  var item = {};
  if (items) {
    for (var i = 0; i < items.length; ++i) {
      if (items[i].slot === slot) {
        item = items[i];
        break;
      }
    }
  }
  this.slot = slot;
  this.armor = ko.observable(item.armor);
  this.strength = ko.observable(item.strength);
  this.dexterity = ko.observable(item.dexterity);
  this.intelligence = ko.observable(item.intelligence);
  this.vitality = ko.observable(item.vitality);
  this.allres = ko.observable(item.allres);
  this.singleres = ko.observable(item.singleres);
  this.regen = ko.observable(item.regen);
  this.mindmg = ko.observable(item.mindmg);
  this.maxdmg = ko.observable(item.maxdmg);
  this.critchance = ko.observable(item.critchance);
  this.critamt = ko.observable(item.critamt);
  this.ias = ko.observable(item.ias);
}

function Weapon(slot, items, character) {
  Item.call(this, slot, items, character);

  this.weapons = [
    {
      name : 'Axe (1h)',
      type : '1h',
      speed: 1.3
    },
    {
      name : 'Axe (2h)',
      type : '2h',
      speed : 1
    },
    {
      name : 'Crossbow',
      type : '2h',
      speed : 1.1
    }
  ];
  var wpn = this.weapons[0];
  if (items) {
    for (var i = 0; i < items.length; ++i) {
      if (items[i].slot === slot) {
        for (var j = 0; j < this.weapons.length; ++j) {
          if (this.weapons[j].name === items[i].wpn.name) {
            wpn = this.weapons[j];
            break;
          }
        }
        break;
      }
    }
  }
  this.wpn = ko.observable(wpn);
}

function Character(saved_data) {
  this.classes = [
    {
      name : 'Barbarian',
      primary : 'strength'
    },
    {
      name : 'Demon Hunter',
      primary : 'dexterity'
    },
    {
      name : 'Monk',
      primary : 'dexterity'
    },
    {
      name : 'Witch Doctor',
      primary : 'intelligence'
    },
    {
      name : 'Wizard',
      primary : 'intelligence',
      skills : [
        {
          name : 'Glass Cannon',
          damage : 15,
          resist : -10,
          armor : -10,
          selected : ko.observable(false)
        },
        {
          name : 'Magic Weapon',
          damage : 10,
          selected : ko.observable(false),
        },
        {
          name : 'Magic Weapon (Force Weapon)',
          damage : 15,
          selected : ko.observable(false)
        },
        {
          name : 'Familiar (Sparkflint)',
          damage : 12,
          selected : ko.observable(false)
        },
        {
          name : 'Energy Armor',
          armor : 65,
          selected : ko.observable(false)
        },
        {
          name : 'Energy Armor (Prismatic Armor)',
          armor : 65,
          resist: 40,
          selected : ko.observable(false)
        }
      ]
    }
  ];

  this.followers = [
    {
      name : 'Scoundrel',
      skills : [
        {
          name : 'Anatomy',
          crit : 3,
          selected : ko.observable(false)
        }
      ]
    }
  ];


  var cur_class = this.classes[0];
  if (saved_data.clss) {
    for (var i = 0; i < this.classes.length; ++i) {
      if (this.classes[i].name === saved_data.clss.name) {
        cur_class = this.classes[i];
        for (var j = 0; j < saved_data.clss.skills.length; ++j) {
          if (saved_data.clss.skills[j].selected) {
            cur_class.skills[j].selected(true);
          }
        }
        break;
      }
    }
  }
  this.clss = ko.observable(cur_class);

  var cur_follower = this.followers[0];
  if (saved_data.follower) {
    for (var i = 0; i < this.followers.length; ++i) {
      if (this.followers[i].name === saved_data.follower.name) {
        cur_follower = this.followers[i];
        for (var j = 0; j < saved_data.follower.skills.length; ++j) {
          if (saved_data.follower.skills[j].selected) {
            cur_follower.skills[j].selected(true);
          }
        }
        break;
      }
    }
  }
  this.follower = ko.observable(cur_follower);

  this.level = ko.observable(saved_data.level || 60);

  this.items = ko.observableArray([
    new Item('Helm', saved_data.items, this),
    new Item('Shoulders', saved_data.items, this),
    new Item('Amulet', saved_data.items, this),
    new Item('Chest', saved_data.items, this),
    new Item('Gloves', saved_data.items, this),
    new Item('Bracers', saved_data.items, this),
    new Item('Belt', saved_data.items, this),
    new Item('Ring (L)', saved_data.items, this),
    new Item('Ring (R)', saved_data.items, this),
    new Item('Pants', saved_data.items, this),
    new Item('Boots', saved_data.items, this),
    new Weapon('Weapon', saved_data.items, this)
  ]);

  this.getSkillStat = function(stat) {
    function helper(skills) {
      var ret = 0;
      for (var i = 0; i < skills.length; ++i) {
        if (skills[i].selected()) {
          ret += skills[i][stat] || 0;
        }
      }
      return ret;
    }
    return helper(this.clss().skills) + helper(this.follower().skills);
  }.bind(this);

  this.getItemStat = function(stat, exclude_item, additional_item) {
    var val = this.items.sum(stat)();
    if (exclude_item !== undefined) {
      val -= this.items()[exclude_item][stat]() || 0;
    }
    if (additional_item) {
      console.warn('Not supported yet ', additional_item);
    }
    return val;
  }.bind(this);

  this.strength = ko.computed(function() {
    return Formula.stat('strength', this);
  }, this);
  this.dexterity = ko.computed(function() {
    return Formula.stat('dexterity', this);
  }, this);
  this.intelligence = ko.computed(function() {
    return Formula.stat('intelligence', this);
  }, this);
  this.vitality = ko.computed(function() {
    return Formula.stat('vitality', this);
  }, this);

  this.life = ko.computed(function() {
    return Formula.life(this);
  }, this);

  this.critchance = ko.computed(function() {
    return Formula.criticalChance(this);
  }, this);

  this.critamt = ko.computed(function() {
    return Formula.criticalAmount(this);
  }, this);

  this.damage = ko.computed(function() {
    return Formula.damage(this);
  }, this);

  this.aps = ko.computed(function() {
    return Formula.attacksPerSecond(this);
  }, this);

  this.dps = ko.computed(function() {
    return Formula.dps(this);
  }, this);

  this.excludedps = function(i) {
    var dps = Formula.dps(this),
        excluded_dps = Formula.dps(this, i);
    return Math.max(0, (dps - excluded_dps) / dps);
  }.bind(this);

  this.armor = ko.computed(function() {
    var armor = this.items.sum('armor')() + this.strength();
    var skill = this.getSkillStat('armor');
    return armor * (1 + skill / 100);
  }, this);

  this.dr = ko.computed(function() {
    // Assumes monsters same level
    return this.armor() / (50 * this.level() + this.armor());
  }, this);

  this.dodge = ko.computed(function() {
    var dex = this.dexterity();
    if (dex <= 100) {
      return dex * 0.001;
    }
    if (dex <= 500) {
      return 0.1 + (dex - 100) * 0.00025;
    }
    if (dex <= 1000) {
      return 0.2 + (dex - 500) * 0.0002;
    }
    return Math.min(0.3 + (dex - 1000) * 0.0001, 1);
  }, this);

  this.avgres = ko.computed(function() {
    var allres = this.items.sum('allres')() + this.intelligence() / 10;
    var singleres = this.items.sum('singleres')() / 6;
    var skill = this.getSkillStat('resist');
    return (allres + singleres) * (1 + skill / 100);
  }, this);

  this.resreduct = ko.computed(function() {
    var res = this.avgres();
    return res / (5 * this.level() + res);
  }, this);

  var total_reduct = function(dodge) {
    var dr = (1 - this.resreduct()) * (1 - this.dr());
    if (dodge) {
      dr *= (1 - this.dodge());
    }
    return dr;
  }.bind(this);

  this.ehp = ko.computed(function() {
    return this.life() / total_reduct();
  }, this);

  this.ehpdodge = ko.computed(function() {
    return this.life() / total_reduct(true);
  }, this);

  this.survive10 = ko.computed(function() {
    var life_gain = this.items.sum('regen')(); // TODO: lph
    var dr = total_reduct(true);
    var life = this.life() + life_gain * 10;
    return (life / dr) / 10;
  }, this);

  // Save data to local storage when anything changes. This is somewhat
  // roundabout because we have to:
  // a) avoid serializing this property along with the rest
  // b) only call the save function once for each change
  var current_data;
  ko.computed(function() {
    return ko.toJSON(this);
  }, this).subscribe(function() {
    setTimeout(function() {
      var json_data = ko.toJSON(this);
      if (json_data !== current_data) {
        localStorage.setItem('d3_data', json_data);
        current_data = json_data;
      }
    }.bind(this), 1);
  }.bind(this));
};
var saved_data = JSON.parse(localStorage.getItem('d3_data')) || {};
ko.applyBindings(new Character(saved_data));
</script>
</body>
</html>
